version: '3'

dotenv: ['.env']

env:
  ROOT: '{{.PWD}}'
  GDB: gdb
  INITRAMFS: '{{.ROOT}}/out/initramfs.cpio'

  SYZKALLER_CFG: '{{.ROOT}}/syzkaller.cfg'
  SYZKALLER_IMG: '{{.ROOT}}/out/syzkaller-image'
  SYZKALLER_PREFIX: '{{.ROOT}}/syzkaller'
  SYZKALLER_BIN: '{{.ROOT}}/syzkaller/bin'
  SYZKALLER_SSH_PORT: 1567

  GDB_PORT: 45457

  LLVMPREFIX: '{{.ROOT}}/llvm-project/build'
  CLANG: '{{.LLVMPREFIX}}/bin/clang'
  CC: '{{.LLVMPREFIX}}/bin/clang'
  CXX: '{{.LLVMPREFIX}}/bin/clang++'
  OPT: '{{.LLVMPREFIX}}/bin/opt'
  LD: '{{.LLVMPREFIX}}/bin/ld.lld'
  LLVM_NM: '{{.LLVMPREFIX}}/bin/llvm-nm'
  LLVM_AR: '{{.LLVMPREFIX}}/bin/llvm-ar'
  LLVM_STRIP: '{{.LLVMPREFIX}}/bin/llvm-strip'
  LLVM_OBJCOPY: '{{.LLVMPREFIX}}/bin/llvm-objcopy'
  LLVM_OBJDUMP: '{{.LLVMPREFIX}}/bin/llvm-objdump'
  LLVM_READELF: '{{.LLVMPREFIX}}/bin/llvm-readelf'
  LLVM_LINK: '{{.LLVMPREFIX}}/bin/llvm-link'
  LLVM_CONFIG: '{{.LLVMPREFIX}}/bin/llvm-config'

  NPROC: 16

  ENABLE_KVM: 1
  # ENABLE_KASAN: 1
  # ENABLE_SYZKALLER: 1
  # ENABLE_DEBUG: 1
  # ENABLE_GDB_BUILD: 1

includes:
  initramfs:  ./taskfiles/TasksInitramfs.yml
  kernel:     ./taskfiles/TasksKernel.yml
  llvm:       ./taskfiles/TasksLLVM.yml
  passes:     ./taskfiles/TasksPasses.yml
  qemu:       ./taskfiles/TasksQemu.yml
  syzkaller:  ./taskfiles/TasksSyzkaller.yml

tasks:
  qemu:
    desc: run the kernel within qemu
    cmds:
      - task: qemu:qemu

  syz:
    desc: run the syzkaller image within qemu
    cmds:
      - task: qemu:syzkaller

  build:
    desc: build static libraries and passes
    cmds:
      - mkdir -p ${KERNEL_LLVM_PASSES}/build
      - cd ${KERNEL_LLVM_PASSES}/build && cmake ..
      - cd ${KERNEL_LLVM_PASSES}/build && make -j${NPROC}
